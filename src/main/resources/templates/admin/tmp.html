<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" >
<head>
    <link rel=stylesheet type="text/css" href="/public_static/css/bootstrap.css">
    <link rel=stylesheet type="text/css" href="/public_static/white_theme.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/public_static/js/bootstrap.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"> </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"> </script>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        article img {
            border-radius: 50%;
        }
        article {
            overflow-wrap: break-word;
        }
        .username {
            text-decoration:none;
        }
    </style>

    <script>

        function errorCallback(error) {
            alert(error.headers.message);
        }

        function getHtmlForArticle(mes) {
            var article_string = `
                <article class="row py-2">
                    <a class="col-auto" href="/public/profile/${mes.username}" style="position:relative;">
                        <img src="/public/photo/${mes.username}" width="60" height="60"
                            alt="аватарка пользователя ${mes.username}">
                        <img src="/public_static/catmaid.jpg" width="60" height="60"
                            alt="кошкогорничная" style="position: absolute; z-index: 99; left:calc(var(--bs-gutter-x) * .5); border-radius:50%;
                            opacity: ${mes.opacity};">
                    </a>
                    <div class="col-sm col-xs-12">
                        <div>
                            <b><a class="username" href="/public/profile/${mes.username}">${mes.username}</a></b>
                        </div>
                        <div>${mes.text}</div>
                    </div>
                </article>`;

            return article_string;
        }

        function getHtmlForPlayer(player) {
            var player_string = `
            <li class="row py-2">
                <a class="col-auto" href="/public/profile/${player.login}" style="position:relative;">
                    <img src="/public/photo/${player.login}" width="60" height="60"
                        alt="аватарка пользователя ${player.login}" style="border-radius:50%;">
                    <img src="/public_static/catmaid.jpg" width="60" height="60"
                        alt="кошкогорничная" style="position: absolute; z-index: 99; left:calc(var(--bs-gutter-x) * .5); border-radius:50%;
                        opacity: ${player.degreeUwU};">
                </a>
                <div class="col-sm col-xs-12">
                    <b><a class="username" href="/public/profile/${player.login}">${player.login}</a></b>
                </div>
            </li>`;

            return player_string;
        }

        function receiveCallback1(messageOutput) {
            var elem = document.getElementById('articles');
            elem.innerHTML = elem.innerHTML + getHtmlForArticle(JSON.parse(messageOutput.body));
        }
        function receiveCallback2(players) {
            players = JSON.parse(players.body);
            var elem = document.getElementById('players');
            string_players = "";

            for (const player of players) {
                console.log(player);
                string_players += getHtmlForPlayer(player);
            }

            var elem = document.getElementById('players');
            elem.innerHTML = string_players;
        }

        function receiveAnnouncementCallback(messageOutput) {
            var announcement_string = `
                <article class="row py-2">
                    <div class="col-sm col-xs-12 text-danger" style="font-size:1.25rem;">
                        <div>Вы отправили слишком много текста в слишком короткий промежуток времени</div>
                    </div>
                </article>`;

            var elem = document.getElementById('articles');
            elem.innerHTML = elem.innerHTML + announcement_string;
        }

        function connectCallback(frame) {
            fetch('/public/chat/get_messages/' + lobby_id.value, {
                headers: {
                    'Accept': 'application/json'
                }
            }).then(
            function(response) {
                if (response.status !== 200) {
                    console.log("Can't load messages. Status Code: " + response.status);
                    return;
                }
                response.json().then(function(data) {
                    string_articles = "";

                    for (const mes of data) {
                        string_articles += getHtmlForArticle(mes);
                    }

                    var elem = document.getElementById('articles');
                    elem.innerHTML = string_articles;
                });

                stompClient.subscribe('/topic/messages/' + lobby_id.value, receiveCallback1);

                stompClient.subscribe('/topic/user/' + username.value, receiveAnnouncementCallback);

                if (!document.getElementById('guestMenu')) {
                    document.getElementById('form_wrapper').style.visibility='visible';
                }

            });

            fetch('/public/room/get_players/' + room_id.value, {
                headers: {
                    'Accept': 'application/json'
                }
            }).then(
            function(response) {
                if (response.status !== 200) {
                    console.log("Can't load players. Status Code: " + response.status);
                    return;
                }
                response.json().then(function(data) {
                    string_players = "";

                    for (const player of data) {
                        string_players += getHtmlForPlayer(player);
                    }

                    var elem = document.getElementById('players');
                    elem.innerHTML = string_players;
                });

                stompClient.subscribe('/topic/players/' + room_id.value, receiveCallback2);
            });
        }

        function connect() {
            var socket = new SockJS('/public/stomp/chat');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, connectCallback, errorCallback);
        }

        function sendMessage(event) {
            event.preventDefault();

            var csrf_token = document.getElementById('_csrf').value;
            var text = document.getElementById('text').value;
            stompClient.send("/app/message/" + lobby_id.value, {'x-csrf-token':csrf_token},
                JSON.stringify({'text':text}));
            document.getElementById('send_message_form').reset();
        }

        function unloadHandler() {
            stompClient.disconnect();
        }

        document.addEventListener("DOMContentLoaded", connect);

        window.onbeforeunload = unloadHandler;
    </script>
</head>
<body>
<header th:replace="~{public/header :: |${@securityService.getAccess()}_header|}"></header>
<main class="container">
    <input type="hidden" name = "username" th:value="${@securityService.getUsername()}" id = "username"/>
    <input type="hidden" name = "room_id" th:value="${room_id}" id = "room_id"/>

    <div class="row">
        <div class="col-12">
            <nav class="navbar navbar-expand-sm bg-light navbar-light" style="z-index:999; position:sticky; top:80px;">

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#chat_menu"
                        aria-controls="chat_menu" aria-expanded="false" aria-label="Toggle chat menu">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div id = "chat_menu" class="row collapse navbar-collapse justify-content-between">
                    <div class="col-auto">
                        <button class="btn btn-outline-secondary" type="button" id="quit_button">выйти</button>
                        <button class="btn btn-outline-secondary" type="button" id="start_button">начать</button>
                    </div>

                    <div class="col-auto">
                        <ul class="nav nav-pills" id="pills-tab" role="tablist">


                            <li th:each="channel : ${channels}" class="nav-item" role="presentation">
                                <button class="nav-link active" th:id="${channel.id} + '-tab'" data-bs-toggle="pill"
                                        th:data-bs-target="'#pills-' + ${channel.id}" type="button" role="tab"
                                        aria-controls="'pills-' + ${channel.id}" aria-selected="true" th:text="${channel.name}"></button>
                            </li>


                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="pills-lobby-tab" data-bs-toggle="pill" data-bs-target="#pills-lobby" type="button" role="tab" aria-controls="pills-lobby" aria-selected="true">лобби</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pills-players-tab" data-bs-toggle="pill" data-bs-target="#pills-players" type="button" role="tab" aria-controls="pills-players" aria-selected="false">игроки</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pills-help-tab" data-bs-toggle="pill" data-bs-target="#pills-help" type="button" role="tab" aria-controls="pills-help" aria-selected="false">помощь</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-lobby" role="tabpanel" aria-labelledby="pills-lobby-tab">
                    <div class="row">
                        <div class = "col-12" id="articles">
                        </div>
                        <div class = "col-12" id = "form_wrapper" style="visibility:hidden;">
                            <form onsubmit="sendMessage(event)" id="send_message_form" class="row py-2" style="position:sticky;bottom:0;">
                                <input type="hidden"
                                       th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}"
                                       id = "_csrf"/>
                                <input type="hidden"
                                       name = "lobby_id"
                                       th:value="${lobby_id}"
                                       id = "lobby_id"/>
                                <div class="col-11">
                                    <textarea class="form-control" rows="3" name="text" id="text"></textarea>
                                </div>
                                <div class="col-1 px-0">
                                    <button class="px-0">
                                        <img src="/public_static/icons/send.svg" width="30" height="30" alt="кнопка отправить">
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="pills-players" role="tabpanel" aria-labelledby="pills-players-tab">
                    <div class = "col-12" id="players">
                    </div>
                </div>
                <div class="tab-pane fade" id="pills-help" role="tabpanel" aria-labelledby="pills-help-tab">
                </div>
            </div>
        </div>
    </div>
</main>
<footer th:replace="~{public/footer :: footer}"></footer>
</body>
</html>